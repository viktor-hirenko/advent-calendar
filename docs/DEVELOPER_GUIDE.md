# Посібник для розробників

Цей документ описує внутрішні механізми календаря та рекомендації щодо розширення функціоналу.

## 1. Компосабли

### 1.1 `createAppConfig` / `useAppConfig`
- **Розташування:** `src/composables/useAppConfig.ts`
- **Призначення:** читає `app-config.json`, нормалізує дані та надає API:
  - `calendarData`, `config`, `calendarDays`, `currentDate`;
  - функції для локалізації (`getLocalizedText`), роботи з датами (`getTaskDate`, `formatTaskDate`, `isToday`, ...);
  - `resolveImg` для перетворення логічних шляхів у URL (працює з Vite glob-імпортами);
  - `resolveTargetUrl` (падіння на `links.primary`).
- **Singleton:** `createAppConfig()` створює інстанс один раз, `useAppConfig()` намагається отримати його через `inject(AppConfigKey)`, а в тестах може створити fallback.
- **Перевірки:** `validateTasksAndDays` попереджає про розбіжність між кількістю задач і довжиною періоду.
- **Поточна дата:** `currentDate` оновлюється кожні 30 с (коли немає `?testDate`), реагує на зміну `timeMode`.

### 1.2 `useLocale`
- **Розташування:** `src/composables/useLocale.ts`
- **Поведінка:** обирає мову за схемою `?language` → `<html lang>` → `defaultLanguage`.
- **Методи:** `currentLanguage` (ref), `setLanguage(lang)` (оновлює `<html lang>`).

### 1.3 `useQueryParams`
- Парсить URL-параметри (language, testDate, debug). Перед редерендером головний composable застосовує їх.

### 1.4 `useMediaQuery`
- Обгортка над `window.matchMedia`; повертає реактивний `ref<boolean>`. Використовується для ввімкнення вирівнювання по тижнях лише на десктопі.

### 1.5 `useTokens`
- Хелпер для читання/зміни CSS-змінних та перемикання тем (`setTheme`).

## 2. Локалізація
- **Базовий набір мов:** `['en', 'de', 'fr', 'it', 'es', 'pt']`.
- **Fallback:** якщо переклад відсутній, система показує англійський.
- **Метадані:** `main.ts` оновлює `<title>` і `<meta name="description">` при зміні мови.
- **Вбудовування в iframe:** усі посилання мають `target="_parent"` (див. `TaskCard.vue`), але значення можна змінити в конфігурації.

## 3. Час та статуси

### 3.1 Налаштування
- `timeMode: 'local'` — день вважається активним, якщо в таймзоні користувача вже настало відповідне число.
- `timeMode: 'utc'` — контроль здійснюється по UTC (рекомендовано для глобальних кампаній).
- `?testDate=YYYY-MM-DD` — примусова дата для QA/демо.

### 3.2 `CalendarDays` + `TaskCard`
- `CalendarContent` при маунті:
  1. скидає `isSelected` для всіх днів;
  2. шукає запис для `currentDate` (або перший день);
  3. синхронізує відображення (виділення дня, скролл до картки).
- Таймер у `TaskCard`:
  - кожні 1 с оновлює `currentTime`;
  - при завершенні змінює статус на `Finished`;
  - для неактивних карток таймер не запускається.
- Стани:
  - **Активна** (сьогодні) — показує таймер і CTA з прямим переходом.
  - **Завершена** (минулі дні) — бейдж “Finished”, кнопка веде на глобальний URL.
  - **Заблокована** (майбутні) — показує дату відкриття, кнопка повертає до поточної задачі.

## 4. Продуктивність
- `CalendarContent` кешує посилання на DOM-елементи (`dayElementsCache`, `cardElementsCache`) для швидкого скролу без повторного пошуку.
- Оновлення активного місяця відбувається в `requestAnimationFrame`, щоб не блокувати скрол.
- Вирівнювання по тижнях (`alignByWeekday`) включається лише на широких екранах (`useMediaQuery('(min-width: 768px)')`).
- Таймер у `TaskCard` очищається через `onScopeDispose`, щоб уникнути витоків при розмонті.

## 5. Рекомендації щодо розширення
1. **Нові типи задач:** додайте поля у `CalendarTask` та розгорніть потрібні гілки у `TaskCard`.
2. **Додаткові події/аналітика:** слухайте `day-click` та `button-click` у `App.vue`, передавайте дані у зовнішній API.
3. **Підтримка RTL:** поточна реалізація `ltr`. Для RTL — додайте перемикач `dir` у `main.ts` залежно від мови і пропишіть стилі.
4. **Валідації контенту:** скрипт `validate-config` можна доповнити правилами (наприклад, ліміт на довжину опису).
5. **Тестування:** при додаванні Vitest створіть фікстури для `calendarDays` і використовуйте `createAppConfig()` як DI.

## 6. Логування та режим налагодження
- `devLog/devWarn` виводять повідомлення лише у development-оточенні (`import.meta.env.DEV`).
- Консольне попередження “Calendar validation…” служить індикатором розбіжності між кількістю днів та задач — його можна вимкнути, якщо повторення задач є бізнес-вимогою.

## 7. Робота з iframe
- Усі зовнішні посилання мають `target="_parent"` для коректного переходу з iframe.
- Якщо потрібно залишатися в iframe — змініть поведінку `TaskCard.handleButtonClick`.

## 8. Стиль-керівництво
- Використовуйте токени та міксини: `@include font-family(primary)`, `@include text(h3)`, `@include mq(lg)` тощо.
- Нові компоненти слід створювати в `src/components`, підключаючи залежності через `@`.
- Стилі по замовчуванню scoped; глобальні правила додавайте в `src/assets/scss/base.scss`.

Дотримання цих рекомендацій забезпечить стабільну роботу календаря та просту підтримку команди у майбутніх релізах.
